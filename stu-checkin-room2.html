<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üéØ Check-in ‡∏´‡πâ‡∏≠‡∏á‡∏¢‡πà‡∏≠‡∏¢ 2</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      padding: 1rem;
    }
    .container {
      max-width: 600px;
      margin: 2rem auto;
      padding: 2rem;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }
    .header-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem;
      border-radius: 15px;
      text-align: center;
      margin-bottom: 1.5rem;
    }
    h2 {
      margin: 0;
      font-weight: 600;
      font-size: 1.5rem;
    }
    .room-label {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-top: 0.25rem;
    }
    #reader {
      width: 100%;
      border-radius: 15px;
      overflow: hidden;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    #statusMessage {
      font-size: 1.1rem;
      font-weight: 500;
      text-align: center;
      padding: 1.5rem;
      border-radius: 12px;
      transition: all 0.3s ease;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .status-icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }
    .detail-text {
      font-size: 0.95rem;
      margin-top: 0.5rem;
      opacity: 0.9;
    }
    .error-details {
      font-size: 0.85rem;
      margin-top: 0.75rem;
      padding: 0.75rem;
      background: rgba(255,255,255,0.2);
      border-radius: 8px;
      max-width: 100%;
      word-break: break-word;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    .pulse {
      animation: pulse 0.5s ease-in-out;
    }
    .config-warning {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }
    .config-warning strong {
      color: #856404;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL -->
    <div id="configWarning" class="config-warning" style="display:none;">
      <strong>‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Backend URL ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</strong><br>
      1. Deploy Apps Script<br>
      2. ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL<br>
      3. ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô JavaScript ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
    </div>

    <div class="header-badge">
      <h2>üì∑ QR Code Check-in</h2>
      <div class="room-label">üéØ ‡∏´‡πâ‡∏≠‡∏á‡∏¢‡πà‡∏≠‡∏¢ 2 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
    </div>
    
    <div id="reader"></div>
    
    <div id="statusMessage" class="bg-light">
      <div class="status-icon">üì±</div>
      <div>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô QR Code</div>
      <div class="detail-text">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏¢‡πà‡∏≠‡∏¢ 2</div>
    </div>
  </div>

  <script>
    // ========================================
    // üîß ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    // ========================================
    
    // ‚ö†Ô∏è ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà URL ‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢ Deployment URL ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const backendUrl = "https://script.google.com/macros/s/AKfycbxZS-xqjMNHs-daghgD0IrEDzySV_ti2lb2CapVu2gDzXqUpNcNT2NkLBaihLXsWxnRVQ/exec";
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    const isConfigured = !backendUrl.includes("YOUR_NEW_DEPLOYMENT_URL_HERE");
    
    if (!isConfigured) {
      document.getElementById('configWarning').style.display = 'block';
      console.error("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ backendUrl ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
    }
    
    // ========================================
    
    const statusMessage = document.getElementById("statusMessage");
    let isProcessing = false;
    let scanCount = 0;

    /**
     * ‡∏™‡πà‡∏á UID ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Backend
     */
    function sendUIDToBackend(uid) {
      if (isProcessing) {
        console.log("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏≠‡∏¢‡∏π‡πà...");
        return;
      }
      
      if (!isConfigured) {
        statusMessage.innerHTML = `
          <div class="status-icon">‚ö†Ô∏è</div>
          <div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</div>
          <div class="detail-text">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Backend URL</div>
        `;
        statusMessage.className = "bg-warning text-dark";
        return;
      }
      
      isProcessing = true;
      scanCount++;

      console.log(`üì± Scan #${scanCount}: ${uid}`);
      console.log(`üîó Calling: ${backendUrl}?uid=${uid}`);

      statusMessage.innerHTML = `
        <div class="status-icon">‚è≥</div>
        <div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏¢‡πà‡∏≠‡∏¢ 2...</div>
        <div class="detail-text">Scan #${scanCount}</div>
      `;
      statusMessage.className = "bg-warning text-dark";

      const startTime = Date.now();
      
      fetch(backendUrl + "?uid=" + encodeURIComponent(uid), {
        method: 'GET',
        redirect: 'follow'
      })
        .then((res) => {
          const duration = Date.now() - startTime;
          console.log(`‚è±Ô∏è Response time: ${duration}ms`);
          console.log(`üìä Response status: ${res.status}`);
          
          if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          }
          
          return res.json();
        })
        .then((data) => {
          console.log("üì¶ Response data:", data);
          
          statusMessage.classList.add('pulse');
          
          if (data.success) {
            const fullname = data.fullname || "‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°";
            const timestamp = new Date(data.timestamp).toLocaleString('th-TH', {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit'
            });
            
            statusMessage.innerHTML = `
              <div class="status-icon">‚úÖ</div>
              <div>
                <strong>${fullname}</strong><br>
                <span style="color: #28a745; font-size: 1.1rem;">‚úì ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
              </div>
              <div class="detail-text">
                ${data.sheetName || '‡∏´‡πâ‡∏≠‡∏á‡∏¢‡πà‡∏≠‡∏¢ 2'}<br>
                ${timestamp}
              </div>
            `;
            statusMessage.className = "bg-success text-white";
            
            // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (optional)
            try {
              const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUpzj77ZiGwU7k9n0yXksBSh+zO/glkALFGGz6+yoVBUIR6Hf8r5tIQUsgs/y2Ik2CBlpu+3mnEwMDlGc4++2YhsFO5HY9Ml5LAUofszt4ZhBCxRgs+zrqFQVCEef4O6+bCEGLIPP8tiJNwgaabzt5ZxNDA5SnOPvtmIbBTuS2PTJeSwFKH7M7+GYQQ0UYLPs66hUFghGoN7vvmwiBi2Bz/LYiTcIG2m88OWaTgwPU53k77ZiGwU6ktnzyXksBSh+y+/imEELFF+y7OyoVBUJR6Hf771sIgYtgc7y2Ik3CBtpvPDlmk4MD1Kd5O+2YhsFOpLZ9Ml5KwYofs3v4ZhBDBRes+zrqFQVCEah3++9bCMGLYHO8tiJNwgaabzw5ZpODA9SnePvtmIbBTqS2PTJeSwGKIDL7+KYQQ0UX7Ps66hUFQlGoN7vvWwiBi2Bzw...');
              audio.play().catch(e => console.log("üîá Audio play failed:", e));
            } catch(e) {
              console.log("üîá Audio not supported");
            }
            
          } else {
            // ‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            const errorMsg = data.error || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏¢‡πà‡∏≠‡∏¢ 2';
            const hint = data.hint || '';
            
            statusMessage.innerHTML = `
              <div class="status-icon">‚ùå</div>
              <div>${errorMsg}</div>
              ${hint ? `<div class="detail-text">${hint}</div>` : ''}
              ${data.debug ? `<div class="error-details">Debug: ${JSON.stringify(data.debug)}</div>` : ''}
            `;
            statusMessage.className = "bg-danger text-white";
            
            console.warn("‚ùå Check-in failed:", data);
          }

          // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡∏•‡∏±‡∏á 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
          setTimeout(() => {
            statusMessage.classList.remove('pulse');
            isProcessing = false;
          }, 5000);
        })
        .catch((err) => {
          console.error("‚ö†Ô∏è Fetch error:", err);
          
          statusMessage.innerHTML = `
            <div class="status-icon">‚ö†Ô∏è</div>
            <div>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ</div>
            <div class="detail-text">Failed to fetch</div>
            <div class="error-details">
              <strong>‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ:</strong><br>
              ‚Ä¢ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Deploy Apps Script<br>
              ‚Ä¢ URL ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á<br>
              ‚Ä¢ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï<br>
              ‚Ä¢ CORS policy blocked<br><br>
              <small>Error: ${err.message}</small>
            </div>
          `;
          statusMessage.className = "bg-danger text-white";
          
          // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡∏•‡∏±‡∏á 8 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
          setTimeout(() => {
            isProcessing = false;
            statusMessage.innerHTML = `
              <div class="status-icon">üì±</div>
              <div>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô QR Code</div>
              <div class="detail-text">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏¢‡πà‡∏≠‡∏¢ 1</div>
            `;
            statusMessage.className = "bg-light";
          }, 8000);
        });
    }

    /**
     * ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô QR Scanner
     */
    function startScanner() {
      console.log("üì∑ Starting QR Scanner...");
      
      const html5QrCode = new Html5Qrcode("reader");
      const config = { 
        fps: 10, 
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1.0,
        formatsToSupport: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
      };

      html5QrCode
        .start(
          { facingMode: "environment" }, // ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á
          config, 
          (decodedText) => {
            console.log("‚úÖ QR Decoded:", decodedText);
            
            if (!isProcessing) {
              html5QrCode.pause(true);
              sendUIDToBackend(decodedText);
              
              // ‡∏£‡∏≠ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà
              setTimeout(() => {
                html5QrCode.resume();
                console.log("üîÑ Scanner resumed");
              }, 3000);
            }
          },
          (errorMessage) => {
            // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error ‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á scanner (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á)
            // console.log("Scanning...", errorMessage);
          }
        )
        .then(() => {
          console.log("‚úÖ QR Scanner started successfully");
        })
        .catch((err) => {
          console.error("‚ùå QR Scanner error:", err);
          
          statusMessage.innerHTML = `
            <div class="status-icon">‚ö†Ô∏è</div>
            <div>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ</div>
            <div class="detail-text">
              ‚Ä¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏•‡πâ‡∏≠‡∏á<br>
              ‚Ä¢ ‡πÉ‡∏ä‡πâ HTTPS ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô<br>
              ‚Ä¢ ‡∏•‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
            </div>
            <div class="error-details">${err.message}</div>
          `;
          statusMessage.className = "bg-danger text-white";
        });
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
    window.addEventListener('load', () => {
      console.log("üöÄ Page loaded, initializing scanner...");
      startScanner();
    });
  </script>
</body>
</html>
